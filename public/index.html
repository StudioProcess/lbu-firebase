<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Let's build utopia</title>
    
    <link href="https://unpkg.com/ionicons@4.5.10-0/dist/css/ionicons.min.css" rel="stylesheet">

    <!-- update the version number as needed -->
    <!-- <script defer src="/__/firebase/6.4.0/firebase-app.js"></script> -->
    <!-- include only the Firebase features as you need -->
    <!-- <script defer src="/__/firebase/6.4.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/6.4.0/firebase-database.js"></script>
    <script defer src="/__/firebase/6.4.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/6.4.0/firebase-storage.js"></script> -->
    <!-- initialize the SDK after all desired features are loaded -->
    <!-- <script defer src="/__/firebase/init.js"></script> -->

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
      #load { display:none; }
    </style>
    
    <style>
      #code { font-family:"Ionicons",system-ui; letter-spacing:0.2em; }
      #photo-display img:not([src]) { display:none; }
      #photo-display img { max-height:100px; width:auto; }
      #message { width: 300px; }
      #sampleDot { width: 30px; }
      #sampleDist { width: 60px; }
    </style>
  </head>
  
  <body>
    <p id="load">Firebase SDK Loading&hellip;</p>
    
    <div>
      uploadCount: <span id="uploadCount"></span>
    </div>
    
    <div>
      populationClock: <span id="populationClock"></span>
    </div>
    
    <div>
      streams: <textarea id="streams"></textarea></br>
    </div>
    
    <div id="form">
      <!-- <label for="name">Name</label> <input id="name" placeholder="Name"><br> -->
      <label for="photo">Photo</label> <input id="photo" type="file" accept="image/*"><br>
      <div id="photo-display"><img></div>
      <label for="message">Message (optional)</label> <input id="message" placeholder="Message (optional)"><br>
      <label for="code">Code</label> <input id="code" placeholder="Code"><br>
      <div id="keypad">
        <button data-digit="0"><i class="icon ion-md-heart"></i></button>
        <button data-digit="1"><i class="icon ion-ios-moon"></i></button>
        <button data-digit="2"><i class="icon ion-md-flower"></i></button>
        <button data-digit="3"><i class="icon ion-ios-star"></i></button>
        <button data-digit="4"><i class="icon ion-ios-sunny"></i></button>
        <button data-digit="5"><i class="icon ion-md-play"></i></button>
        <button data-digit="6"><i class="icon ion-md-cloud"></i></button>
        <button data-digit="7"><i class="icon ion-ios-square"></i></button>
        <button data-digit="8"><i class="icon ion-md-water"></i></button>
        <button data-digit="9"><i class="icon ion-ios-happy"></i></button>
        <button class="delete">delete</button><br>
      </div>
      <button id="submit" type="submit">Submit</button><br>
      <label for="sampleDot">dot</label> <input id="sampleDot" type="number" min="0" max="321" value="1"> <label for="sampleDist">distance</label> <input id="sampleDist" type="number" min="0" value="100"> <button id="sample" type="submit">Submit Sample Data</button><br>
      <label for="sampleDotLoc">dot</label> <input id="sampleDotLoc" type="number" min="0" max="321" value="1"> <label for="sampleLat">latitude</label> <input id="sampleLat" type="number" min="-90" max="90" value="50.5" step="0.1"> <label for="sampleLng">longitude</label> <input id="sampleLng" type="number" min="-180" max="180" value="0" step="0.1"> <button id="sampleLoc" type="submit">Submit Sample Data</button><br>
      <div id="log"></div>
    </div>
    
    <!-- Firebase App is always required and must be first -->
    <script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-app.js"></script>
    <!-- Add additional services that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-storage.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-functions.js"></script> -->

    <script type='module'>
      function clearLog() { document.querySelector('#log').innerText = ''; }
      function log(str, obj) { 
        let el = document.querySelector('#log'); 
        el.innerText += str;
        if (obj) {
          el.innerText += ' ' + JSON.stringify(obj);
        }
        el.innerText += '\n';
      }
    
      import * as lbu from './lbu.js';
      const config = {
        apiKey: "AIzaSyCdr0kpTbsED6du_p-RulO_m4L7aglFoio",
        projectId: "letsbuildutopia-84770",
        storageBucket: "letsbuildutopia-84770.appspot.com",
      };
      lbu.init(config);
      
      lbu.setupImageSelect({
        input: '#photo',
        image: '#photo-display img'
      });
      
      lbu.setupCodeEntry({
        code_input: '#code',
        digit_buttons: '#keypad button[data-digit]',
        delete_button: '#keypad button.delete'
      });
      
      lbu.setupPopCounter({
        selector: '#populationClock',
        interval: 1000
      });
      
      lbu.setupUploadCounter({
        selector: '#uploadCount',
      }).then( () => {
        log('NOTE: upload count ready');
      });
      
      lbu.onData(data => {
        document.querySelector('#streams').value = JSON.stringify(data, null, 2);
      }).then( () => {
        log('NOTE: dot data ready');
      })
      
      document.querySelector('#submit').addEventListener('click', e => {
        clearLog();
        log('UPLOAD STARTED');
        lbu.upload({
          file: document.querySelector('#photo').files[0],
          code: document.querySelector('#code').value,
          onProgress: status => {
            log('PROGRESS', status);
          },
          onLocation: loc => {
            log('LOCATION', loc);
          },
        }).then(_res => {
          log('SUCCESS'); // not printing res, has circular JSON
        }).catch(err => {
          log('ERROR', err);
          throw err;
        });
      });
      
      
      // test sample data
      lbu.loadSampleData().then(() => {
        log('NOTE: sample data ready');
      });
      
      lbu.sampleLocation( [48.2, 16.366667] ).then( point => {
        console.log(point);
      });
      
      lbu.sampleLocation( [48.2, 16.366667], 50 ).then( point => {
        console.log(point);
      });
      
      lbu.samplePic().then(pic => {
        console.log(pic);
        // document.querySelector('#photo-display img').src = pic.dataURL;
      });
      
      lbu.uploadCode(1).then(code => {
        console.log(code);
      });
      
      // Sample data button
      document.querySelector('#sample').addEventListener('click', e => {
        // get dot number from input element (can be empty)
        let dotNum = parseInt( document.querySelector('#sampleDot').value );
        let distance = parseInt( document.querySelector('#sampleDist').value );
        
        // get sample upload data
        clearLog();
        log('GETTING SAMPLE DATA');
        lbu.sampleUpload({dotNum, distance}).then(upload => {
          // update interface
          document.querySelector('#message').value = upload.message;
          document.querySelector('#code').value = upload.codeSymbols;
          document.querySelector('#photo-display img').src = upload.dataURL;
          delete upload.dataURL;
          log('DATA', upload);
          
          log('UPLOAD STARTED');
          upload.onProgress = status => { log('PROGRESS', status) };
          upload.onLocation = loc => { log('LOCATION', loc) };
          lbu.upload(upload).then(() => {
            log('SUCCESS'); // not printing res, has circular JSON
          }).catch( err => {
            log('ERROR', err);
            throw err;
          });
        });
      });
      
      // Sample data with location button
      document.querySelector('#sampleLoc').addEventListener('click', e => {
        // get dot number from input element (can be empty)
        let dotNum = parseInt( document.querySelector('#sampleDotLoc').value );
        let latitude = parseFloat( document.querySelector('#sampleLat').value.replace(',', '.') );
        let longitude = parseFloat( document.querySelector('#sampleLng').value.replace(',', '.') );
        
        // get sample upload data
        clearLog();
        log('GETTING SAMPLE DATA (LOCATION GIVEN)');
        lbu.sampleUpload({dotNum, latitude, longitude}).then(upload => {
          // update interface
          document.querySelector('#message').value = upload.message;
          document.querySelector('#code').value = upload.codeSymbols;
          document.querySelector('#photo-display img').src = upload.dataURL;
          delete upload.dataURL;
          log('DATA', upload);
          
          log('UPLOAD STARTED');
          upload.onProgress = status => { log('PROGRESS', status) };
          upload.onLocation = loc => { log('LOCATION', loc) };
          lbu.upload(upload).then(() => {
            log('SUCCESS'); // not printing res, has circular JSON
          }).catch( err => {
            log('ERROR', err);
            throw err;
          });
        });
      });
      
  </script>
  
  </body>
</html>
